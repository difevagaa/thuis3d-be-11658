import { useState } from "react";
import { useTranslation } from "react-i18next";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Slider } from "@/components/ui/slider";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { 
  Palette, 
  Type, 
  Layout, 
  Maximize, 
  AlignLeft, 
  AlignCenter, 
  AlignRight,
  Image as ImageIcon,
  Smartphone,
  Tablet,
  Monitor,
  Link as LinkIcon,
  Move,
  Box,
  Sparkles
} from "lucide-react";
import { MediaLibrary } from "./MediaLibrary";

interface PageBuilderSettingsProps {
  section: any;
  onUpdate: (updates: any) => void;
}

export function PageBuilderSettings({ section, onUpdate }: PageBuilderSettingsProps) {
  const { t } = useTranslation(['admin', 'common']);
  const [mediaLibraryOpen, setMediaLibraryOpen] = useState(false);
  const [mediaTargetField, setMediaTargetField] = useState<string>('');

  if (!section) {
    return (
      <div className="p-4 text-center text-muted-foreground">
        <p>Selecciona una sección para editar</p>
      </div>
    );
  }

  const openMediaLibrary = (field: string) => {
    setMediaTargetField(field);
    setMediaLibraryOpen(true);
  };

  const handleMediaSelect = (url: string) => {
    if (mediaTargetField) {
      handleContentChange(mediaTargetField, url);
    }
  };

  const handleStyleChange = (property: string, value: any) => {
    onUpdate({
      styles: {
        ...section.styles,
        [property]: value
      }
    });
  };

  const handleSettingsChange = (property: string, value: any) => {
    onUpdate({
      settings: {
        ...section.settings,
        [property]: value
      }
    });
  };

  const handleContentChange = (property: string, value: any) => {
    onUpdate({
      content: {
        ...section.content,
        [property]: value
      }
    });
  };

  return (
    <div className="p-4 space-y-4">
      <Tabs defaultValue="general" className="w-full">
        <TabsList className="grid w-full grid-cols-4">
          <TabsTrigger value="general">General</TabsTrigger>
          <TabsTrigger value="sizing">Tamaño</TabsTrigger>
          <TabsTrigger value="responsive">Móvil</TabsTrigger>
          <TabsTrigger value="advanced">Avanzado</TabsTrigger>
        </TabsList>

        {/* GENERAL TAB */}
        <TabsContent value="general" className="space-y-4 mt-4">
          <Accordion type="multiple" defaultValue={['general', 'content', 'styles']}>
            {/* General Settings */}
            <AccordionItem value="general">
              <AccordionTrigger className="text-sm font-medium">
                <div className="flex items-center gap-2">
                  <Layout className="h-4 w-4" />
                  General
                </div>
              </AccordionTrigger>
              <AccordionContent className="space-y-4 pt-4">
                <div className="space-y-2">
                  <Label className="text-xs">Nombre de la sección</Label>
                  <Input
                    value={section.section_name}
                    onChange={(e) => onUpdate({ section_name: e.target.value })}
                    placeholder="Nombre"
                  />
                </div>

                <div className="flex items-center justify-between">
                  <Label className="text-xs">Visible</Label>
                  <Switch
                    checked={section.is_visible}
                    onCheckedChange={(checked) => onUpdate({ is_visible: checked })}
                  />
                </div>

                <div className="flex items-center justify-between">
                  <Label className="text-xs">Ancho completo</Label>
                  <Switch
                    checked={section.settings?.fullWidth || false}
                    onCheckedChange={(checked) => handleSettingsChange('fullWidth', checked)}
                  />
                </div>
              </AccordionContent>
            </AccordionItem>

            {/* Content */}
            <AccordionItem value="content">
              <AccordionTrigger className="text-sm font-medium">
                <div className="flex items-center gap-2">
                  <Type className="h-4 w-4" />
                  Contenido
                </div>
              </AccordionTrigger>
              <AccordionContent className="space-y-4 pt-4">
                {section.section_type !== 'spacer' && section.section_type !== 'divider' && (
                  <>
                    <div className="space-y-2">
                      <Label className="text-xs">Título</Label>
                      <Input
                        value={section.content?.title || ''}
                        onChange={(e) => handleContentChange('title', e.target.value)}
                        placeholder="Título"
                      />
                    </div>

                    {['hero', 'text', 'banner', 'cta'].includes(section.section_type) && (
                      <div className="space-y-2">
                        <Label className="text-xs">
                          {section.section_type === 'text' ? 'Texto' : 'Subtítulo / Descripción'}
                        </Label>
                        <textarea
                          value={section.content?.subtitle || section.content?.text || section.content?.description || ''}
                          onChange={(e) => {
                            const key = section.section_type === 'text' ? 'text' : 
                                       section.section_type === 'banner' || section.section_type === 'cta' ? 'description' : 'subtitle';
                            handleContentChange(key, e.target.value);
                          }}
                          placeholder="Escribe tu contenido..."
                          className="w-full min-h-[80px] px-3 py-2 text-sm rounded-md border bg-background resize-none"
                        />
                      </div>
                    )}

                    {['hero', 'banner', 'cta'].includes(section.section_type) && (
                      <>
                        <div className="space-y-2">
                          <Label className="text-xs">Texto del botón</Label>
                          <Input
                            value={section.content?.buttonText || ''}
                            onChange={(e) => handleContentChange('buttonText', e.target.value)}
                            placeholder="Ver más"
                          />
                        </div>
                        <div className="space-y-2">
                          <Label className="text-xs">URL del botón</Label>
                          <Input
                            value={section.content?.buttonUrl || ''}
                            onChange={(e) => handleContentChange('buttonUrl', e.target.value)}
                            placeholder="/productos"
                          />
                        </div>
                      </>
                    )}

                    {['hero', 'banner', 'image'].includes(section.section_type) && (
                      <div className="space-y-2">
                        <Label className="text-xs">
                          {section.section_type === 'image' ? 'URL de la imagen' : 'Imagen de fondo'}
                        </Label>
                        <div className="flex gap-2">
                          <Input
                            value={section.content?.backgroundImage || section.content?.imageUrl || ''}
                            onChange={(e) => {
                              const key = section.section_type === 'image' ? 'imageUrl' : 'backgroundImage';
                              handleContentChange(key, e.target.value);
                            }}
                            placeholder="https://..."
                            className="flex-1"
                          />
                          <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={() => openMediaLibrary(section.section_type === 'image' ? 'imageUrl' : 'backgroundImage')}
                          >
                            <ImageIcon className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    )}
                  </>
                )}

                {section.section_type === 'spacer' && (
                  <div className="space-y-2">
                    <Label className="text-xs">Altura (px): {section.settings?.height || 60}</Label>
                    <Slider
                      value={[section.settings?.height || 60]}
                      onValueChange={([value]) => handleSettingsChange('height', value)}
                      min={20}
                      max={200}
                      step={10}
                    />
                  </div>
                )}
              </AccordionContent>
            </AccordionItem>

            {/* Styles */}
            <AccordionItem value="styles">
              <AccordionTrigger className="text-sm font-medium">
                <div className="flex items-center gap-2">
                  <Palette className="h-4 w-4" />
                  Estilos Básicos
                </div>
              </AccordionTrigger>
              <AccordionContent className="space-y-4 pt-4">
                <div className="space-y-2">
                  <Label className="text-xs">Color de fondo</Label>
                  <div className="flex gap-2">
                    <Input
                      type="color"
                      value={section.styles?.backgroundColor || '#ffffff'}
                      onChange={(e) => handleStyleChange('backgroundColor', e.target.value)}
                      className="w-12 h-9 p-1 cursor-pointer"
                    />
                    <Input
                      value={section.styles?.backgroundColor || ''}
                      onChange={(e) => handleStyleChange('backgroundColor', e.target.value)}
                      placeholder="Transparente"
                      className="flex-1"
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Color de texto</Label>
                  <div className="flex gap-2">
                    <Input
                      type="color"
                      value={section.styles?.textColor || '#000000'}
                      onChange={(e) => handleStyleChange('textColor', e.target.value)}
                      className="w-12 h-9 p-1 cursor-pointer"
                    />
                    <Input
                      value={section.styles?.textColor || ''}
                      onChange={(e) => handleStyleChange('textColor', e.target.value)}
                      placeholder="Heredar"
                      className="flex-1"
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Padding: {section.styles?.padding || 40}px</Label>
                  <Slider
                    value={[section.styles?.padding || 40]}
                    onValueChange={([value]) => handleStyleChange('padding', value)}
                    min={0}
                    max={120}
                    step={4}
                  />
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Alineación</Label>
                  <div className="flex gap-1">
                    <Button
                      variant={section.styles?.textAlign === 'left' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => handleStyleChange('textAlign', 'left')}
                      className="flex-1"
                    >
                      <AlignLeft className="h-4 w-4" />
                    </Button>
                    <Button
                      variant={section.styles?.textAlign === 'center' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => handleStyleChange('textAlign', 'center')}
                      className="flex-1"
                    >
                      <AlignCenter className="h-4 w-4" />
                    </Button>
                    <Button
                      variant={section.styles?.textAlign === 'right' ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => handleStyleChange('textAlign', 'right')}
                      className="flex-1"
                    >
                      <AlignRight className="h-4 w-4" />
                    </Button>
                  </div>
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Radio de bordes</Label>
                  <Select
                    value={section.styles?.borderRadius || 'none'}
                    onValueChange={(value) => handleStyleChange('borderRadius', value)}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Seleccionar" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="none">Sin bordes</SelectItem>
                      <SelectItem value="sm">Pequeño</SelectItem>
                      <SelectItem value="md">Mediano</SelectItem>
                      <SelectItem value="lg">Grande</SelectItem>
                      <SelectItem value="full">Completo</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </AccordionContent>
            </AccordionItem>
          </Accordion>
        </TabsContent>

        {/* SIZING TAB - NEW COMPREHENSIVE SIZING OPTIONS */}
        <TabsContent value="sizing" className="space-y-4 mt-4">
          <Accordion type="multiple" defaultValue={['dimensions', 'spacing', 'typography']}>
            {/* Dimension Controls */}
            <AccordionItem value="dimensions">
              <AccordionTrigger className="text-sm font-medium">
                <div className="flex items-center gap-2">
                  <Maximize className="h-4 w-4" />
                  Dimensiones
                </div>
              </AccordionTrigger>
              <AccordionContent className="space-y-4 pt-4">
                {/* Width Controls */}
                <div className="space-y-2">
                  <Label className="text-xs">Ancho</Label>
                  <Select
                    value={section.styles?.width || 'auto'}
                    onValueChange={(value) => handleStyleChange('width', value)}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Automático" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="auto">Automático</SelectItem>
                      <SelectItem value="25%">25%</SelectItem>
                      <SelectItem value="50%">50%</SelectItem>
                      <SelectItem value="75%">75%</SelectItem>
                      <SelectItem value="100%">100%</SelectItem>
                      <SelectItem value="custom">Personalizado</SelectItem>
                    </SelectContent>
                  </Select>
                  {section.styles?.width === 'custom' && (
                    <Input
                      value={section.styles?.customWidth || ''}
                      onChange={(e) => handleStyleChange('customWidth', e.target.value)}
                      placeholder="ej. 500px, 80%, 50vw"
                    />
                  )}
                </div>

                {/* Height Controls */}
                <div className="space-y-2">
                  <Label className="text-xs">Altura</Label>
                  <Select
                    value={section.styles?.height || 'auto'}
                    onValueChange={(value) => handleStyleChange('height', value)}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Automático" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="auto">Automático</SelectItem>
                      <SelectItem value="300px">Pequeño (300px)</SelectItem>
                      <SelectItem value="500px">Mediano (500px)</SelectItem>
                      <SelectItem value="700px">Grande (700px)</SelectItem>
                      <SelectItem value="50vh">50% pantalla</SelectItem>
                      <SelectItem value="75vh">75% pantalla</SelectItem>
                      <SelectItem value="100vh">Pantalla completa</SelectItem>
                      <SelectItem value="custom">Personalizado</SelectItem>
                    </SelectContent>
                  </Select>
                  {section.styles?.height === 'custom' && (
                    <Input
                      value={section.styles?.customHeight || ''}
                      onChange={(e) => handleStyleChange('customHeight', e.target.value)}
                      placeholder="ej. 400px, 60vh"
                    />
                  )}
                </div>

                {/* Min/Max Width */}
                <div className="space-y-2">
                  <Label className="text-xs">Ancho mínimo</Label>
                  <Input
                    value={section.styles?.minWidth || ''}
                    onChange={(e) => handleStyleChange('minWidth', e.target.value)}
                    placeholder="ej. 320px, 20rem"
                  />
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Ancho máximo</Label>
                  <Input
                    value={section.styles?.maxWidth || ''}
                    onChange={(e) => handleStyleChange('maxWidth', e.target.value)}
                    placeholder="ej. 1200px, 80rem"
                  />
                </div>

                {/* Min/Max Height */}
                <div className="space-y-2">
                  <Label className="text-xs">Altura mínima</Label>
                  <Input
                    value={section.styles?.minHeight || ''}
                    onChange={(e) => handleStyleChange('minHeight', e.target.value)}
                    placeholder="ej. 200px, 20vh"
                  />
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Altura máxima</Label>
                  <Input
                    value={section.styles?.maxHeight || ''}
                    onChange={(e) => handleStyleChange('maxHeight', e.target.value)}
                    placeholder="ej. 800px, 90vh"
                  />
                </div>

                {/* Aspect Ratio */}
                <div className="space-y-2">
                  <Label className="text-xs">Relación de aspecto</Label>
                  <Select
                    value={section.styles?.aspectRatio || 'none'}
                    onValueChange={(value) => handleStyleChange('aspectRatio', value)}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Sin restricción" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="none">Sin restricción</SelectItem>
                      <SelectItem value="1/1">Cuadrado (1:1)</SelectItem>
                      <SelectItem value="4/3">Estándar (4:3)</SelectItem>
                      <SelectItem value="16/9">Panorámico (16:9)</SelectItem>
                      <SelectItem value="21/9">Ultra ancho (21:9)</SelectItem>
                      <SelectItem value="3/2">Fotografía (3:2)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </AccordionContent>
            </AccordionItem>

            {/* Detailed Spacing Controls */}
            <AccordionItem value="spacing">
              <AccordionTrigger className="text-sm font-medium">
                <div className="flex items-center gap-2">
                  <Box className="h-4 w-4" />
                  Espaciado Detallado
                </div>
              </AccordionTrigger>
              <AccordionContent className="space-y-4 pt-4">
                {/* Individual Padding */}
                <div className="space-y-2">
                  <Label className="text-xs font-semibold">Padding Individual</Label>
                  <div className="grid grid-cols-2 gap-2">
                    <div className="space-y-1">
                      <Label className="text-xs text-muted-foreground">Superior</Label>
                      <Input
                        type="number"
                        value={section.styles?.paddingTop || ''}
                        onChange={(e) => handleStyleChange('paddingTop', e.target.value)}
                        placeholder="px"
                      />
                    </div>
                    <div className="space-y-1">
                      <Label className="text-xs text-muted-foreground">Inferior</Label>
                      <Input
                        type="number"
                        value={section.styles?.paddingBottom || ''}
                        onChange={(e) => handleStyleChange('paddingBottom', e.target.value)}
                        placeholder="px"
                      />
                    </div>
                    <div className="space-y-1">
                      <Label className="text-xs text-muted-foreground">Izquierda</Label>
                      <Input
                        type="number"
                        value={section.styles?.paddingLeft || ''}
                        onChange={(e) => handleStyleChange('paddingLeft', e.target.value)}
                        placeholder="px"
                      />
                    </div>
                    <div className="space-y-1">
                      <Label className="text-xs text-muted-foreground">Derecha</Label>
                      <Input
                        type="number"
                        value={section.styles?.paddingRight || ''}
                        onChange={(e) => handleStyleChange('paddingRight', e.target.value)}
                        placeholder="px"
                      />
                    </div>
                  </div>
                </div>

                {/* Individual Margin */}
                <div className="space-y-2">
                  <Label className="text-xs font-semibold">Margin Individual</Label>
                  <div className="grid grid-cols-2 gap-2">
                    <div className="space-y-1">
                      <Label className="text-xs text-muted-foreground">Superior</Label>
                      <Input
                        type="number"
                        value={section.styles?.marginTop || ''}
                        onChange={(e) => handleStyleChange('marginTop', e.target.value)}
                        placeholder="px"
                      />
                    </div>
                    <div className="space-y-1">
                      <Label className="text-xs text-muted-foreground">Inferior</Label>
                      <Input
                        type="number"
                        value={section.styles?.marginBottom || ''}
                        onChange={(e) => handleStyleChange('marginBottom', e.target.value)}
                        placeholder="px"
                      />
                    </div>
                    <div className="space-y-1">
                      <Label className="text-xs text-muted-foreground">Izquierda</Label>
                      <Input
                        type="number"
                        value={section.styles?.marginLeft || ''}
                        onChange={(e) => handleStyleChange('marginLeft', e.target.value)}
                        placeholder="px"
                      />
                    </div>
                    <div className="space-y-1">
                      <Label className="text-xs text-muted-foreground">Derecha</Label>
                      <Input
                        type="number"
                        value={section.styles?.marginRight || ''}
                        onChange={(e) => handleStyleChange('marginRight', e.target.value)}
                        placeholder="px"
                      />
                    </div>
                  </div>
                </div>

                {/* Gap */}
                <div className="space-y-2">
                  <Label className="text-xs">Espacio entre elementos: {section.styles?.gap || 16}px</Label>
                  <Slider
                    value={[section.styles?.gap || 16]}
                    onValueChange={([value]) => handleStyleChange('gap', value)}
                    min={0}
                    max={64}
                    step={4}
                  />
                </div>
              </AccordionContent>
            </AccordionItem>

            {/* Typography Controls */}
            <AccordionItem value="typography">
              <AccordionTrigger className="text-sm font-medium">
                <div className="flex items-center gap-2">
                  <Type className="h-4 w-4" />
                  Tipografía Avanzada
                </div>
              </AccordionTrigger>
              <AccordionContent className="space-y-4 pt-4">
                <div className="space-y-2">
                  <Label className="text-xs">Tamaño de fuente: {section.styles?.fontSize || 16}px</Label>
                  <Slider
                    value={[section.styles?.fontSize || 16]}
                    onValueChange={([value]) => handleStyleChange('fontSize', value)}
                    min={8}
                    max={72}
                    step={1}
                  />
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Peso de fuente</Label>
                  <Select
                    value={section.styles?.fontWeight || 'normal'}
                    onValueChange={(value) => handleStyleChange('fontWeight', value)}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="100">Thin (100)</SelectItem>
                      <SelectItem value="300">Light (300)</SelectItem>
                      <SelectItem value="normal">Normal (400)</SelectItem>
                      <SelectItem value="500">Medium (500)</SelectItem>
                      <SelectItem value="600">Semibold (600)</SelectItem>
                      <SelectItem value="bold">Bold (700)</SelectItem>
                      <SelectItem value="800">Extra Bold (800)</SelectItem>
                      <SelectItem value="900">Black (900)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Altura de línea: {section.styles?.lineHeight || 1.5}</Label>
                  <Slider
                    value={[section.styles?.lineHeight || 1.5]}
                    onValueChange={([value]) => handleStyleChange('lineHeight', value)}
                    min={1}
                    max={3}
                    step={0.1}
                  />
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Espaciado de letras: {section.styles?.letterSpacing || 0}px</Label>
                  <Slider
                    value={[section.styles?.letterSpacing || 0]}
                    onValueChange={([value]) => handleStyleChange('letterSpacing', value)}
                    min={-2}
                    max={10}
                    step={0.5}
                  />
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Transformación de texto</Label>
                  <Select
                    value={section.styles?.textTransform || 'none'}
                    onValueChange={(value) => handleStyleChange('textTransform', value)}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="none">Normal</SelectItem>
                      <SelectItem value="uppercase">MAYÚSCULAS</SelectItem>
                      <SelectItem value="lowercase">minúsculas</SelectItem>
                      <SelectItem value="capitalize">Capitalizar</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Decoración de texto</Label>
                  <Select
                    value={section.styles?.textDecoration || 'none'}
                    onValueChange={(value) => handleStyleChange('textDecoration', value)}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="none">Ninguna</SelectItem>
                      <SelectItem value="underline">Subrayado</SelectItem>
                      <SelectItem value="overline">Línea superior</SelectItem>
                      <SelectItem value="line-through">Tachado</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label className="text-xs">Familia de fuente</Label>
                  <Select
                    value={section.styles?.fontFamily || 'inherit'}
                    onValueChange={(value) => handleStyleChange('fontFamily', value)}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="inherit">Heredar</SelectItem>
                      <SelectItem value="sans-serif">Sans Serif</SelectItem>
                      <SelectItem value="serif">Serif</SelectItem>
                      <SelectItem value="monospace">Monospace</SelectItem>
                      <SelectItem value="cursive">Cursive</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </AccordionContent>
            </AccordionItem>
          </Accordion>
        </TabsContent>

      {/* Media Library Dialog */}
      <MediaLibrary
        open={mediaLibraryOpen}
        onClose={() => setMediaLibraryOpen(false)}
        onSelect={handleMediaSelect}
      />
    </div>
  );
}
